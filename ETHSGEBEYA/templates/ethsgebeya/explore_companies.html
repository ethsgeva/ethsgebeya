{% extends 'ethsgebeya/public_base.html' %}
{% load static %}

{% block title %}Explore Companies — ETHSGEBEYA{% endblock %}

{% block styles %}
<style>
    :root { --brand-color:#4da6ff; --brand-light:#e6f2ff; --brand-dark:#1a75ff; --brand-gradient:linear-gradient(135deg,#4da6ff 0%, #1a75ff 100%); --text-dark:#2C3E50; --text-light:#7F8C8D; --white:#fff; --shadow:0 4px 15px rgba(77,166,255,.12); --shadow-hover:0 8px 25px rgba(77,166,255,.18);}    
    .page-title{ text-align:center; margin:1.5rem 0 1rem; }
    .page-title h1{ font-size:2rem; font-weight:700; background:var(--brand-gradient); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
    .controls{ background:var(--white); padding:1rem; border-radius:12px; box-shadow:var(--shadow); margin-bottom:1.5rem; display:flex; flex-direction:column; gap:1rem; }
    .search-bar{ position:relative; width:100%; }
    .search-bar input{ width:100%; padding:.8rem .8rem .8rem 2.5rem; border:1.5px solid var(--brand-light); border-radius:10px; font-size:.95rem; }
    .search-icon{ position:absolute; left:.8rem; top:50%; transform:translateY(-50%); color:var(--brand-color); }
    .filter-tags{ display:flex; gap:.6rem; flex-wrap:wrap; justify-content:center; }
    .filter-tag{ padding:.5rem 1rem; background:var(--brand-light); border:none; border-radius:16px; cursor:pointer; font-weight:600; color:var(--brand-color); font-size:.85rem; }
    .filter-tag.active{ background:var(--brand-color); color:#fff; }
    .companies-grid{ display:grid; grid-template-columns:1fr; gap:1rem; }
    .company-card{ background:#fff; border-radius:12px; overflow:hidden; box-shadow:var(--shadow); border:1.5px solid var(--brand-light); }
    .company-card::before{ content:''; display:block; height:3px; background:var(--brand-gradient); }
    .company-header{ padding:1rem; display:flex; gap:.8rem; }
    .company-avatar{ width:50px; height:50px; border-radius:12px; display:flex; align-items:center; justify-content:center; color:#fff; font-weight:700; background:var(--brand-gradient); overflow:hidden; }
    .company-stats{ display:grid; grid-template-columns:repeat(3,1fr); gap:.8rem; padding:.8rem 1rem; background:var(--brand-light); margin:0 1rem; border-radius:10px; text-align:center; }
    .stat-value{ font-size:1.1rem; font-weight:800; color:var(--brand-color); }
    .stat-label{ font-size:.7rem; color:var(--brand-color); font-weight:600; opacity:.8; }
    .company-actions{ padding:1rem; display:flex; gap:.6rem; border-top:1px solid var(--brand-light); justify-content:flex-start; }
    .btn{ padding:.35rem .6rem; border-radius:8px; font-weight:600; font-size:.875rem; }
    .btn-primary{ background:var(--brand-gradient); color:#fff; }
    .btn-secondary{ background:transparent; border:1.5px solid var(--brand-color); color:var(--brand-color); }
    @media(min-width:768px){ .companies-grid{ grid-template-columns:repeat(2,1fr); } }
    @media(min-width:1024px){ .companies-grid{ grid-template-columns:repeat(3,1fr); } }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="page-title">
        <h1>Explore Companies</h1>
        <p class="text-muted">All registered companies on ETHSGEBEYA.</p>
        <a class="btn btn-secondary btn-sm" href="{% url 'companies' %}"><i class="fas fa-arrow-left me-1"></i> Back to Followed</a>
    </div>

    <div class="controls">
        <div class="search-bar">
            <span class="search-icon"><i class="fas fa-search"></i></span>
            <input type="text" id="searchInput" placeholder="Search companies...">
        </div>
        <div class="filter-tags">
            <button class="filter-tag active" data-category="all">All</button>
            <button class="filter-tag" data-category="product_seller"><i class="fas fa-box"></i> Product Sellers</button>
            <button class="filter-tag" data-category="cafe_restaurant"><i class="fas fa-coffee"></i> Cafes & Restaurants</button>
            <button class="filter-tag" data-category="service_provider"><i class="fas fa-tools"></i> Service Providers</button>
        </div>
    </div>

    <div class="companies-grid" id="exploreGrid">
        {% for seller in all_sellers %}
        <div class="company-card" data-category="{{ seller.business_type }}">
            <div class="company-header">
                <div class="company-avatar">
                    {% if seller.create_logo %}
                        <img src="{{ seller.create_logo.url }}" alt="{{ seller.company_name }}" style="width:100%;height:100%;object-fit:cover;">
                    {% else %}
                        <span>{{ seller.company_name|slice:":2"|upper }}</span>
                    {% endif %}
                </div>
                <div class="company-info">
                    <div class="company-name-wrapper" style="display:flex; align-items:center; gap:.5rem; flex-wrap:wrap;">
                        <div class="company-name" style="font-weight:700;">{{ seller.company_name }}</div>
                        {% if seller.is_verified %}
                            <span class="badge bg-success">Verified</span>
                        {% endif %}
                        <span class="company-category {{ seller.business_type }} badge bg-light text-primary">
                            {{ seller.get_business_type_display|upper }}
                        </span>
                    </div>
                    {% if seller.opening_time and seller.closing_time %}
                    <div class="small text-muted">
                        <i class="fas fa-clock me-1"></i>
                        {{ seller.opening_time|time:"g:i A" }} - {{ seller.closing_time|time:"g:i A" }}
                        {% if seller.is_open_now %}<span class="text-success fw-semibold ms-2">● Open Now</span>{% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="company-stats">
                <div class="stat"><div class="stat-value">{{ seller.followers.count }}</div><div class="stat-label">FOLLOWERS</div></div>
                <div class="stat"><div class="stat-value">{{ seller.avg_rating|default:"4.5" }}</div><div class="stat-label">RATING</div></div>
                <div class="stat"><div class="stat-value">{{ seller.product_set.count }}</div><div class="stat-label">PRODUCTS</div></div>
            </div>

            <div class="company-description p-3 text-muted">{{ seller.description|truncatewords:30 }}</div>

            <div class="company-actions">
                <a href="{% url 'seller_profile' seller.id %}" class="btn btn-primary btn-sm"><i class="fas fa-eye me-1"></i> View Profile</a>
                <form method="post" action="{% url 'toggle_follow_seller' seller_id=seller.id %}" class="d-inline">
                    {% csrf_token %}
                    {% if request.user.is_authenticated and seller.is_following %}
                        <button type="submit" class="btn btn-secondary btn-sm"><i class="fas fa-user-minus me-1"></i> Unfollow</button>
                    {% else %}
                        <button type="submit" class="btn btn-secondary btn-sm"><i class="fas fa-user-plus me-1"></i> Follow</button>
                    {% endif %}
                </form>
            </div>
        </div>
        {% empty %}
        <div class="text-center text-muted py-5">
            <h5>No companies registered yet.</h5>
        </div>
        {% endfor %}
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function(){
        const searchInput=document.getElementById('searchInput');
        const tags=[...document.querySelectorAll('.filter-tag')];
        function filterSection(sectionSelector){
            const cards=[...document.querySelectorAll(sectionSelector+' .company-card')];
            const term=(searchInput.value||'').toLowerCase();
            const active=(document.querySelector('.filter-tag.active')?.dataset.category)||'all';
            cards.forEach(card=>{
                const name=card.querySelector('.company-name')?.textContent.toLowerCase()||'';
                const desc=card.querySelector('.company-description')?.textContent.toLowerCase()||'';
                const cat=card.dataset.category;
                const match=(name.includes(term)||desc.includes(term)) && (active==='all'||cat===active);
                card.style.display=match?'block':'none';
            });
        }
        function applyFilters(){ filterSection('#exploreGrid'); }
        searchInput.addEventListener('input', applyFilters);
        tags.forEach(t=>t.addEventListener('click',()=>{ tags.forEach(x=>x.classList.remove('active')); t.classList.add('active'); applyFilters(); }));
    });
</script>
{% endblock %}
