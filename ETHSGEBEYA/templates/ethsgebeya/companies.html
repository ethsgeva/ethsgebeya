{% extends 'warehouse/base.html' %}
{% load static %}

{% block title %}Following Companies ¡¤ ETHSGEBEYA{% endblock %}

{% block styles %}
<style>
    :root {
        --brand-color: #4da6ff;
        --brand-light: #e6f2ff;
        --brand-dark: #1a75ff;
        --brand-gradient: linear-gradient(135deg, #4da6ff 0%, #1a75ff 100%);
        --text-dark: #2C3E50;
        --text-light: #7F8C8D;
        --white: #ffffff;
        --shadow: 0 4px 15px rgba(77, 166, 255, 0.12);
        --shadow-hover: 0 8px 25px rgba(77, 166, 255, 0.18);
    }

    body.following-page {
        background: linear-gradient(135deg, #f5f7fa 0%, #e6f2ff 100%);
        color: var(--text-dark);
    }

    .fp-header {
        background: var(--brand-gradient);
        color: white;
        padding: 1.5rem 1rem;
        text-align: center;
        position: relative;
        overflow: hidden;
        border-radius: 14px;
        box-shadow: var(--shadow);
    }

    .fp-header h1 {
        font-size: 1.6rem;
        font-weight: 700;
        margin-bottom: 0.4rem;
        background: linear-gradient(45deg, #fff, #e6f2ff);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .fp-header p {
        font-size: 0.95rem;
        opacity: 0.95;
    }

    .fp-controls {
        background: var(--white);
        padding: 1rem;
        border-radius: 12px;
        box-shadow: var(--shadow);
        margin: 1rem 0 1.2rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .fp-search {
        position: relative;
        width: 100%;
    }

    .fp-search input {
        width: 100%;
        padding: 0.8rem 0.8rem 0.8rem 2.5rem;
        border: 1.5px solid var(--brand-light);
        border-radius: 10px;
        font-size: 0.95rem;
        outline: none;
        transition: all 0.3s ease;
        background: var(--white);
    }

    .fp-search input:focus { border-color: var(--brand-color); box-shadow: 0 0 0 2px rgba(77, 166, 255, 0.1); }
    .fp-search .icon { position: absolute; left: 0.8rem; top: 50%; transform: translateY(-50%); color: var(--brand-color); font-size: 1rem; }

    .fp-tags { display: flex; gap: 0.6rem; flex-wrap: wrap; justify-content: center; }
    .fp-tag { padding: 0.5rem 1rem; background: var(--brand-light); border: none; border-radius: 16px; cursor: pointer; transition: all 0.3s ease; font-weight: 600; color: var(--brand-color); font-size: 0.85rem; white-space: nowrap; }
    .fp-tag.active { background: var(--brand-color); color: white; }

    .fp-grid { display: grid; grid-template-columns: 1fr; gap: 1rem; }

    .fp-card { background: var(--white); border-radius: 12px; overflow: hidden; box-shadow: var(--shadow); transition: all 0.3s ease; position: relative; border: 1.5px solid var(--brand-light); }
    .fp-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-hover); border-color: var(--brand-color); }
    .fp-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: var(--brand-gradient); }

    .fp-header-row { padding: 1rem; display: flex; align-items: flex-start; gap: 0.8rem; }
    .fp-avatar { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.2rem; font-weight: bold; flex-shrink: 0; box-shadow: 0 4px 12px rgba(77, 166, 255, 0.25); background: var(--brand-gradient); }
    .fp-info { flex: 1; }
    .fp-name { font-size: 1.1rem; font-weight: 700; margin-bottom: 0.3rem; color: var(--text-dark); }
    .fp-cat { display: inline-block; padding: 0.2rem 0.6rem; background: var(--brand-light); color: var(--brand-color); border-radius: 10px; font-size: 0.7rem; font-weight: 600; }

    .fp-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.8rem; padding: 0.8rem 1rem; background: var(--brand-light); margin: 0 1rem; border-radius: 10px; text-align: center; }
    .fp-stat { display: flex; flex-direction: column; }
    .fp-stat-val { font-size: 1.1rem; font-weight: 800; color: var(--brand-color); }
    .fp-stat-label { font-size: 0.7rem; color: var(--brand-color); font-weight: 600; opacity: 0.8; }

    .fp-desc { padding: 0.8rem 1rem; color: var(--text-light); line-height: 1.4; font-size: 0.9rem; }

    .fp-actions { padding: 1rem; display: flex; gap: 0.6rem; border-top: 1px solid var(--brand-light); }
    .btn { padding: 0.6rem 0.8rem; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; text-align: center; font-size: 0.9rem; display: flex; align-items: center; justify-content: center; gap: 0.3rem; }
    .btn-primary { background: var(--brand-gradient); color: white; flex: 2; }
    .btn-secondary { background: transparent; border: 1.5px solid var(--brand-color); color: var(--brand-color); flex: 1; }
    .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(77, 166, 255, 0.25); }
    .btn-secondary:hover { background: var(--brand-light); transform: translateY(-1px); }

    .fp-empty { text-align: center; padding: 2rem 1rem; color: var(--text-light); grid-column: 1 / -1; }
    .fp-empty h3 { margin-bottom: 0.8rem; color: var(--text-dark); font-size: 1.1rem; }

    @media (min-width: 768px) {
        .fp-header h1 { font-size: 1.8rem; }
        .fp-controls { flex-direction: row; align-items: center; padding: 1.2rem; }
        .fp-grid { grid-template-columns: repeat(2, 1fr); gap: 1.5rem; }
    }
    @media (min-width: 1024px) { .fp-grid { grid-template-columns: repeat(3, 1fr); } }
</style>
{% endblock %}

{% block page_title %}
<h1>Following Companies</h1>
{% endblock %}

{% block content %}
<div id="following-root" class="following-page">
    <div class="fp-header">
        <h1>Following Companies</h1>
        <p>Discover amazing stores you follow</p>
    </div>

    <div class="fp-controls">
        <div class="fp-search">
            <span class="icon"><i class="fas fa-search"></i></span>
            <input type="text" id="searchInput" placeholder="Search companies...">
        </div>
        <div class="fp-tags">
            <button class="fp-tag active" data-category="all">All</button>
            <button class="fp-tag" data-category="cafe"><i class="fas fa-coffee"></i> Cafes</button>
            <button class="fp-tag" data-category="restaurant"><i class="fas fa-utensils"></i> Restaurants</button>
            <button class="fp-tag" data-category="retail"><i class="fas fa-shopping-bag"></i> Shops</button>
            <button class="fp-tag" data-category="service"><i class="fas fa-tools"></i> Services</button>
        </div>
    </div>

    <div class="fp-grid" id="companiesGrid"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Injected from backend
    const COMPANIES = JSON.parse('{{ companies_json|escapejs }}');

    const iconMap = {
        'coffee': 'fas fa-coffee',
        'utensils': 'fas fa-utensils',
        'shopping-bag': 'fas fa-shopping-bag',
        'tools': 'fas fa-tools',
        'book': 'fas fa-book',
        'shopping-cart': 'fas fa-shopping-cart',
        'building': 'fas fa-building'
    };

    const companiesGrid = document.getElementById('companiesGrid');
    const searchInput = document.getElementById('searchInput');
    const filterTags = document.querySelectorAll('.fp-tag');

    function numberFormat(val) {
        if (typeof val !== 'number') return val || 0;
        if (val >= 1000) return (val/1000).toFixed(1).replace(/\.0$/,'') + 'K';
        return val;
    }

    function renderCompanies(list) {
        companiesGrid.innerHTML = '';
        if (!list || list.length === 0) {
            companiesGrid.innerHTML = `
                <div class="fp-empty">
                    <h3>No companies found</h3>
                    <p>Try adjusting your search or filter criteria</p>
                </div>`;
            return;
        }
        list.forEach(company => {
            const el = document.createElement('div');
            el.className = 'fp-card';
            el.innerHTML = `
                <div class="fp-header-row">
                    <div class="fp-avatar"><i class="${iconMap[company.icon] || 'fas fa-building'}"></i></div>
                    <div class="fp-info">
                        <div class="fp-name">${company.name}</div>
                        <div class="fp-cat">${company.category.toUpperCase()}</div>
                    </div>
                </div>
                <div class="fp-stats">
                    <div class="fp-stat"><div class="fp-stat-val">${numberFormat(company.followers)}</div><div class="fp-stat-label">FOLLOWERS</div></div>
                    <div class="fp-stat"><div class="fp-stat-val">${company.rating?.toFixed(1)}</div><div class="fp-stat-label">RATING</div></div>
                    <div class="fp-stat"><div class="fp-stat-val">${company.products}</div><div class="fp-stat-label">PRODUCTS</div></div>
                </div>
                <div class="fp-desc">${company.description || ''}</div>
                <div class="fp-actions">
                    <a class="btn btn-primary" href="${makeStoreUrl(company.id)}"><i class="fas fa-eye"></i> View Profile</a>
                    <button class="btn btn-secondary" data-unfollow="${company.id}"><i class="fas fa-user-minus"></i> Unfollow</button>
                </div>`;
            companiesGrid.appendChild(el);
        });

        // Wire unfollow buttons
        document.querySelectorAll('[data-unfollow]').forEach(btn => {
            btn.addEventListener('click', () => {
                const id = btn.getAttribute('data-unfollow');
                if (!confirm('Are you sure you want to unfollow this store?')) return;
                toggleFollow(id, false);
            });
        });
    }

    function makeStoreUrl(id) {
        // Assuming URL pattern /warehouse/store/<id>/
        return `${window.location.origin}/warehouse/store/${id}/`;
    }

    function activeCategory() {
        const active = document.querySelector('.fp-tag.active');
        return active ? active.dataset.category : 'all';
    }

    function filterCompanies() {
        const searchTerm = (searchInput.value || '').toLowerCase();
        const category = activeCategory();
        const filtered = (COMPANIES || []).filter(c => {
            const matchesSearch = (c.name || '').toLowerCase().includes(searchTerm) || (c.description || '').toLowerCase().includes(searchTerm);
            const matchesCategory = category === 'all' || c.category === category;
            return matchesSearch && matchesCategory;
        });
        renderCompanies(filtered);
    }

    function getCsrfToken() {
        // Prefer cookie. Fallback to hidden input in base navbar if exists
        const match = document.cookie.match(/csrftoken=([^;]+)/);
        if (match) return match[1];
        const input = document.querySelector('input[name=csrfmiddlewaretoken]');
        return input ? input.value : '';
    }

    async function toggleFollow(sellerId, expectFollowed) {
        try {
            const resp = await fetch(`${window.location.origin}/warehouse/api/seller/${sellerId}/toggle-follow/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCsrfToken(),
                },
            });
            if (!resp.ok) throw new Error('Request failed');
            const data = await resp.json();
            // Remove the card if now unfollowed
            if (!data.followed) {
                const idx = COMPANIES.findIndex(c => c.id == sellerId);
                if (idx !== -1) {
                    COMPANIES.splice(idx, 1);
                    filterCompanies();
                }
            }
        } catch (e) {
            alert('Could not update follow status. Please try again.');
        }
    }

    // Event listeners
    searchInput.addEventListener('input', filterCompanies);
    document.querySelectorAll('.fp-tag').forEach(tag => {
        tag.addEventListener('click', () => {
            document.querySelectorAll('.fp-tag').forEach(t => t.classList.remove('active'));
            tag.classList.add('active');
            filterCompanies();
        });
    });

    // Initial render
    renderCompanies(COMPANIES);
</script>
{% endblock %}
