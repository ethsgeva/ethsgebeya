{% extends 'warehouse/base.html' %}
{% load static %}

{% block page_title %}
<div class="d-flex justify-content-between align-items-center">
    <h1>Product Management</h1>
    <a href="{% url 'add_product' %}" class="btn btn-primary mx-2">
        <i class="fas fa-plus me-2 "></i>Add Product
    </a>
</div>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Filters and Controls -->
    <div class="card shadow-sm mb-4">
        <div class="card-body p-3">
            <form method="get" class="row g-3 align-items-center">
                <!-- Search -->
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text bg-light border-0">
                            <i class="fas fa-search"></i>
                        </span>
                        {{ form.q }}
                    </div>
                </div>
                
                <!-- Filters -->
                <div class="col-md-8">
                    <div class="d-flex flex-wrap justify-content-end gap-2">
                        <!-- Category Filter -->
                        <div class="dropdown">
                            <button class="btn btn-outline-primary dropdown-toggle" type="button" 
                                    id="categoryDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-tag me-2"></i>
                                {% if form.category.value %}
                                    {% for category in categories %}
                                        {% if category.id|stringformat:'s' == form.category.value|stringformat:'s' %}
                                            {{ category.name }}
                                        {% endif %}
                                    {% endfor %}
                                {% else %}
                                    Category
                                {% endif %}
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="categoryDropdown">
                                <li><a class="dropdown-item" href="#" data-filter="category" data-value="">All Categories</a></li>
                                {% for category in categories %}
                                <li><a class="dropdown-item" href="#" data-filter="category" data-value="{{ category.id }}">{{ category.name }}</a></li>
                                {% endfor %}
                            </ul>
                        </div>
                        
                        <!-- In Stock Filter -->
                        <div class="form-check form-switch d-flex align-items-center">
                            <input class="form-check-input" type="checkbox" name="in_stock" id="id_in_stock" {% if request.GET.in_stock %}checked{% endif %}>
                            <label class="form-check-label ms-2" for="id_in_stock">In Stock</label>
                        </div>
                        
                        <!-- Status Filter -->
                        <div class="dropdown">
                            <button class="btn btn-outline-primary dropdown-toggle" type="button" 
                                    id="statusFilterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-filter me-2"></i>
                                {% if request.GET.status %}{{ request.GET.status|title }}{% else %}Status{% endif %}
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="statusFilterDropdown">
                                <li><a class="dropdown-item" href="#" data-filter="status" data-value="">All Statuses</a></li>
                                <li><a class="dropdown-item" href="#" data-filter="status" data-value="active">Active</a></li>
                                <li><a class="dropdown-item" href="#" data-filter="status" data-value="draft">Draft</a></li>
                                <li><a class="dropdown-item" href="#" data-filter="status" data-value="archived">Archived</a></li>
                            </ul>
                        </div>
                        
                        <!-- Sort Dropdown -->
                        <div class="dropdown">
                            <button class="btn btn-outline-primary dropdown-toggle" type="button" 
                                    id="sortDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-sort me-2"></i>
                                {% if request.GET.sort %}{{ request.GET.sort|title }}{% else %}Sort By{% endif %}
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="sortDropdown">
                                <li><a class="dropdown-item" href="#" data-filter="sort" data-value="-created_at">Newest First</a></li>
                                <li><a class="dropdown-item" href="#" data-filter="sort" data-value="created_at">Oldest First</a></li>
                                <li><a class="dropdown-item" href="#" data-filter="sort" data-value="title">Name (A-Z)</a></li>
                                <li><a class="dropdown-item" href="#" data-filter="sort" data-value="-title">Name (Z-A)</a></li>
                                <li><a class="dropdown-item" href="#" data-filter="sort" data-value="price">Price (Low to High)</a></li>
                                <li><a class="dropdown-item" href="#" data-filter="sort" data-value="-price">Price (High to Low)</a></li>
                                <li><a class="dropdown-item" href="#" data-filter="sort" data-value="in_stock">Stock (Low to High)</a></li>
                                <li><a class="dropdown-item" href="#" data-filter="sort" data-value="-in_stock">Stock (High to Low)</a></li>
                            </ul>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-filter me-2"></i>Apply
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Product Count -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="fw-bold">
            Showing {{ products.start_index }} - {{ products.end_index }} of {{ total_products }} products
        </div>
        <div class="text-muted">
            {% if form.q.value %}
                Search: "{{ form.q.value }}"
            {% endif %}
        </div>
    </div>

    <!-- Product Cards -->
    <div class="row" id="productContainer">
        {% for product in seller_products %}
        <div class="col-xl-3 col-lg-4 col-md-6 mb-4">
            <div class="card product-card h-100 border-0 shadow-sm">
                <div class="position-relative">
                    <a href="{% url 'product_detail' product.id %}">
                    {% if product.images.all %}
                        <img src="{{ product.images.all.0.image.url }}" class="card-img-top" alt="{{ product.title }}">
                    {% else %}
                    <div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 200px;">
                        <i class="fas fa-image fa-3x text-muted"></i>
                    </div>
                    {% endif %}
                    </a>
                    <div class="card-img-overlay d-flex justify-content-end">
                        <div class="product-badges">
                            <span class="badge bg-{% if product.status == 'active' %}success{% elif product.status == 'draft' %}warning{% else %}secondary{% endif %}">
                                {{ product.get_status_display }}
                            </span>
                            {% if product.category %}
                            <span class="badge bg-primary">{{ product.category.name }}</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <h5 class="card-title mb-1">
                        <a href="{% url 'product_detail' product.id %}" style="color:inherit; text-decoration:none;">
                            {{ product.title }}
                        </a>
                    </h5>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-muted small">SKU: {{ product.id }}</span>
                        <div class="stock-indicator">
                            <span class="badge bg-{% if product.in_stock > 0 %}success{% else %}danger{% endif %}">
                                {% if product.in_stock > 0 %}{{ product.in_stock }} in stock{% else %}Out of stock{% endif %}
                            </span>
                        </div>
                    </div>
                    <p class="card-text text-truncate-2">{{ product.description }}</p>
                    
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div>
                            <span class="h5 mb-0">ETB {{ product.price }}</span>
                        </div>
                        <div class="product-actions">
                            <a href="#" class="btn btn-outline-primary btn-sm me-1" data-bs-toggle="tooltip" title="Edit (Coming Soon)" onclick="showToast('Product editing is coming soon! Stay tuned for this feature.', 'info'); return false;">
                                <i class="fas fa-edit"></i>
                            </a>
                            <a href="{% url 'delete_product' product.id %}" class="btn btn-outline-danger btn-sm" data-bs-toggle="tooltip" title="Delete">
                                <i class="fas fa-trash"></i>
                            </a>
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-white border-0 d-flex justify-content-between">
                    <small class="text-muted">
                        <i class="far fa-calendar me-1"></i> {{ product.created_at|date:"M d, Y" }}
                    </small>
                    <small class="text-muted">
                        <i class="fas fa-sync-alt me-1"></i> {{ product.updated_at|date:"M d, Y" }}
                    </small>
                </div>
            </div>
        </div>
        {% empty %}
        <!-- Empty State -->
        <div class="card shadow-sm">
            <div class="card-body">
                <div class="empty-state text-center py-5">
                    <i class="fas fa-box-open fa-4x text-muted mb-4"></i>
                    <h3 class="mb-3">No Products Found</h3>
                    <p class="text-muted mb-4">Try adjusting your filters or add a new product</p>
                    <a href="{% url 'add_product' %}" class="btn btn-primary px-4">
                        <i class="fas fa-plus me-2"></i>Add Product
                    </a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    
    <!-- Pagination -->
    {% if products.paginator.num_pages > 1 %}
    <nav class="d-flex justify-content-center mt-4">
        <ul class="pagination">
            {% if products.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page=1" aria-label="First">
                    <i class="fas fa-angle-double-left"></i>
                </a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ products.previous_page_number }}" aria-label="Previous">
                    <i class="fas fa-angle-left"></i>
                </a>
            </li>
            {% else %}
            <li class="page-item disabled">
                <a class="page-link" href="#" tabindex="-1" aria-disabled="true">
                    <i class="fas fa-angle-double-left"></i>
                </a>
            </li>
            <li class="page-item disabled">
                <a class="page-link" href="#" tabindex="-1" aria-disabled="true">
                    <i class="fas fa-angle-left"></i>
                </a>
            </li>
            {% endif %}
            
            {% for num in products.paginator.page_range %}
                {% if products.number == num %}
                <li class="page-item active" aria-current="page">
                    <a class="page-link" href="#">{{ num }}</a>
                </li>
                {% elif num > products.number|add:'-3' and num < products.number|add:'3' %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                </li>
                {% endif %}
            {% endfor %}
            
            {% if products.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ products.next_page_number }}" aria-label="Next">
                    <i class="fas fa-angle-right"></i>
                </a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ products.paginator.num_pages }}" aria-label="Last">
                    <i class="fas fa-angle-double-right"></i>
                </a>
            </li>
            {% else %}
            <li class="page-item disabled">
                <a class="page-link" href="#" tabindex="-1" aria-disabled="true">
                    <i class="fas fa-angle-right"></i>
                </a>
            </li>
            <li class="page-item disabled">
                <a class="page-link" href="#" tabindex="-1" aria-disabled="true">
                    <i class="fas fa-angle-double-right"></i>
                </a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</div>

<!-- Attractive Notification overlay and toast logic for Edit button -->
<div id="centered-notification" style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(1.08);min-width:320px;max-width:90vw;z-index:3000;background:linear-gradient(135deg,#e3f0ff 0%,#f8fafd 100%);border-radius:22px;box-shadow:0 12px 40px rgba(34,74,190,0.18),0 2px 8px rgba(0,0,0,0.10);padding:38px 28px 28px 28px;text-align:center;font-size:1.18rem;font-weight:600;transition:opacity 0.3s,border 0.3s; border:3px solid #4e73df;">
  <button class="close-btn" onclick="hideNotification()" style="position:absolute;top:12px;right:22px;background:none;border:none;font-size:1.7rem;color:#224abe;cursor:pointer;opacity:0.7;transition:color 0.2s;">&times;</button>
  <div style="display:flex;flex-direction:column;align-items:center;gap:10px;">
    <span id="centered-notification-icon" style="font-size:2.5rem;display:block;"></span>
    <span id="centered-notification-message"></span>
  </div>
</div>
<script>
function showToast(message, type='info') {
    const notif = document.getElementById('centered-notification');
    const msg = document.getElementById('centered-notification-message');
    const icon = document.getElementById('centered-notification-icon');
    notif.className = type;
    msg.innerHTML = message;
    let iconHtml = '';
    if(type==='success') iconHtml = '<i class="fas fa-check-circle" style="color:#28a745;"></i>';
    else if(type==='danger'||type==='error') iconHtml = '<i class="fas fa-times-circle" style="color:#dc3545;"></i>';
    else iconHtml = '<i class="fas fa-info-circle" style="color:#224abe;"></i>';
    icon.innerHTML = iconHtml;
    notif.style.display = 'block';
    notif.style.opacity = 1;
    notif.style.borderColor = (type==='success') ? '#28a745' : (type==='danger'||type==='error') ? '#dc3545' : '#4e73df';
    if (notif._timeout) clearTimeout(notif._timeout);
    notif._timeout = setTimeout(() => { hideNotification(); }, 3500);
}
function hideNotification() {
    const notif = document.getElementById('centered-notification');
    notif.style.opacity = 0;
    setTimeout(() => { notif.style.display = 'none'; }, 300);
}
</script>

<style>
    /* Product Cards */
    .product-card {
        border-radius: 12px;
        overflow: hidden;
        transition: all 0.3s ease;
        border: 1px solid #eaeaea;
    }
    
    .product-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        border-color: #d0d0d0;
    }
    
    .product-card .card-img-top {
        height: 200px;
        object-fit: cover;
        transition: transform 0.5s ease;
    }
    
    .product-card:hover .card-img-top {
        transform: scale(1.03);
    }
    
    .product-badges {
        position: absolute;
        top: 15px;
        right: 15px;
        display: flex;
        flex-direction: column;
        gap: 5px;
    }
    
    .text-truncate-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        height: 48px;
    }
    
    .product-actions {
        display: flex;
        gap: 5px;
    }
    
    .product-actions .btn {
        border-radius: 50%;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
    }
    
    .stock-indicator .badge {
        font-weight: 500;
        padding: 5px 10px;
    }
    
    /* Filters */
    .input-group {
        border-radius: 50px;
        background: #f8f9fc;
    }
    
    .input-group .input-group-text {
        background: transparent;
        border: none;
    }
    
    .input-group input {
        background: transparent;
        border: none;
        box-shadow: none !important;
    }
    
    /* Pagination */
    .pagination .page-item .page-link {
        border-radius: 8px;
        margin: 0 3px;
        border: none;
        color: #5a5c69;
    }
    
    .pagination .page-item.active .page-link {
        background: linear-gradient(135deg, #4e73df 0%, #224abe 100%);
        border-color: transparent;
    }
    
    /* Empty State */
    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 40px 20px;
        text-align: center;
        background: #f8f9fc;
        border-radius: 12px;
        border: 2px dashed #e3e6f0;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Tooltip initialization
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Dropdown filter selection
    document.querySelectorAll('.dropdown-item[data-filter]').forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            const filterName = this.getAttribute('data-filter');
            const filterValue = this.getAttribute('data-value');
            const form = document.querySelector('form');
            // Remove any existing input for this filter
            let input = form.querySelector(`input[name="${filterName}"]`);
            if (!input) {
                input = document.createElement('input');
                input.type = 'hidden';
                input.name = filterName;
                form.appendChild(input);
            }
            input.value = filterValue;
            // Remove page param to avoid redirecting to a non-existent page
            let pageInput = form.querySelector('input[name="page"]');
            if (pageInput) pageInput.remove();
            // Submit the form via GET
            form.method = 'get';
            form.action = window.location.pathname;
            form.submit();
        });
    });
});
</script>
{% endblock %}

<!--<a href="{% url 'edit_product' product.id %}" class="btn btn-sm btn-outline-primary" data-bs-toggle="tooltip" title="Edit">
    <i class="fas fa-edit"></i>
</a>
<a href="{% url 'delete_product' product.id %}" class="btn btn-sm btn-outline-danger" data-bs-toggle="tooltip" title="Delete">
    <i class="fas fa-trash"></i>
</a>-->