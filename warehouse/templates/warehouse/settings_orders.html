{% extends 'warehouse/base.html' %}
{% load static %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-12 col-lg-3 mb-4">
            <div class="list-group shadow-sm rounded-3">
                <a href="{% url 'setting' %}" class="list-group-item list-group-item-action">Profile Settings</a>
                <a href="{% url 'settings_orders_page' %}" class="list-group-item list-group-item-action active">Orders & Wishlist</a>
            </div>
        </div>
        <div class="col-12 col-lg-9">
            {% if role == 'buyer' %}
                <div class="card shadow-sm mb-4 border-0 rounded-4">
                    <div class="card-body">
                        <h4 class="mb-3" style="color:#36b9cc; font-weight:600;">Your Cart</h4>
                        {% if cart and cart|length > 0 %}
                            <ul class="list-group mb-4">
                                {% for item in cart %}
                                <li class="list-group-item d-flex justify-content-between align-items-center border-0 border-bottom py-3" style="background:rgba(54,185,204,0.04);">
                                    <span class="d-flex align-items-center">
                                        {% if item.product.images.all %}
                                            <img src="{{ item.product.images.all.0.image.url }}" alt="{{ item.product.title }}" style="width: 60px; height: 60px; object-fit: cover; margin-right: 16px; border-radius: 10px; box-shadow:0 2px 8px rgba(54,185,204,0.12);">
                                        {% endif %}
                                        <div>
                                            <a href="{% url 'product_detail' item.product.id %}" class="fw-bold text-decoration-none" style="font-size:1.1rem; color:#212529;">{{ item.product.title }}</a>
                                            <div class="small text-muted">x{{ item.quantity }} &middot; <span style="color:#36b9cc; font-weight:500;">ETB {{ item.total_price }}</span></div>
                                        </div>
                                    </span>
                                    <div class="d-flex align-items-center gap-2">
                                        <a href="#" class="btn btn-sm btn-success px-3 rounded-pill" style="font-weight:500;" onclick="showToast('Placing orders is coming soon! Stay tuned for this feature.', 'info'); return false;">Place Order</a>
                                        <form method="post" action="{% url 'cart_remove' product_id=item.product.id %}" class="d-inline">{% csrf_token %}
                                            <button type="submit" class="btn btn-sm btn-outline-danger px-3 rounded-pill">Remove</button>
                                        </form>
                                    </div>
                                </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p class="text-center text-muted">Your cart is empty.</p>
                        {% endif %}
                    </div>
                </div>
                <div class="card shadow-sm mb-4 border-0 rounded-4">
                    <div class="card-body">
                        <h4 class="mb-3" style="color:#f6c23e; font-weight:600;">Your Wishlist</h4>
                        {% with wishlist=request.user.wishlists.first %}
                        {% if wishlist and wishlist.products.all %}
                            <ul class="list-group mb-4">
                                {% for product in wishlist.products.all %}
                                <li class="list-group-item d-flex justify-content-between align-items-center border-0 border-bottom py-3" style="background:rgba(246,194,62,0.06);">
                                    <span class="d-flex align-items-center">
                                        {% if product.images.all %}
                                            <img src="{{ product.images.all.0.image.url }}" alt="{{ product.title }}" style="width: 60px; height: 60px; object-fit: cover; margin-right: 16px; border-radius: 10px; box-shadow:0 2px 8px rgba(246,194,62,0.12);">
                                        {% endif %}
                                        <div>
                                            <a href="{% url 'product_detail' product.id %}" class="fw-bold text-decoration-none" style="font-size:1.1rem; color:#212529;">{{ product.title }}</a>
                                        </div>
                                    </span>
                                    <form method="post" action="{% url 'remove_from_wishlist' %}" class="d-inline">{% csrf_token %}
                                        <input type="hidden" name="product_id" value="{{ product.id }}">
                                        <button type="submit" class="btn btn-sm btn-outline-danger px-3 rounded-pill">Remove</button>
                                    </form>
                                </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p class="text-center text-muted">Your wishlist is empty.</p>
                        {% endif %}
                        {% endwith %}
                    </div>
                </div>
                <!-- Orders Section: Pending, Waiting, Completed, All -->
                <div class="row g-4">
                    <div class="col-12 col-lg-6">
                        <div class="card shadow-sm border-0 rounded-4 h-100">
                            <div class="card-body">
                                <h4 class="mb-3" style="color:#858796; font-weight:600;">Pending Orders</h4>
                                {% if pending_orders %}
                                    <ul class="list-group mb-4">
                                        {% for order in pending_orders %}
                                        <li class="list-group-item d-flex justify-content-between align-items-center border-0 border-bottom py-3" style="background:rgba(133,135,150,0.06);">
                                            <span>
                                                <span class="fw-bold">{{ order.product.title }}</span> (x{{ order.quantity }}) - <span style="color:#858796;">${{ order.total_price }}</span>
                                            </span>
                                            <span class="badge bg-secondary">Pending</span>
                                            <span class="text-muted small">{{ order.created_at|date:'Y-m-d H:i' }}</span>
                                        </li>
                                        {% endfor %}
                                    </ul>
                                {% else %}
                                    <p class="text-center text-muted">No pending orders.</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-lg-6">
                        <div class="card shadow-sm border-0 rounded-4 h-100">
                            <div class="card-body">
                                <h4 class="mb-3" style="color:#f6c23e; font-weight:600;">Orders Waiting for Your Confirmation</h4>
                                {% if waiting_orders %}
                                    <ul class="list-group mb-4">
                                        {% for order in waiting_orders %}
                                        <li class="list-group-item d-flex justify-content-between align-items-center border-0 border-bottom py-3" style="background:rgba(246,194,62,0.06);">
                                            <span>
                                                <span class="fw-bold">{{ order.product.title }}</span> (x{{ order.quantity }}) - <span style="color:#f6c23e;">${{ order.total_price }}</span>
                                            </span>
                                            <span class="badge bg-warning text-dark">Waiting for Your Confirmation</span>
                                            <button class="btn btn-warning btn-sm ms-2 rounded-pill" onclick="confirmOrderComplete('{{ order.id }}')">Confirm Completion</button>
                                        </li>
                                        {% endfor %}
                                    </ul>
                                {% else %}
                                    <p class="text-center text-muted">No orders waiting for your confirmation.</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card shadow-sm mt-4 border-0 rounded-4">
                    <div class="card-body">
                        <h4 class="mb-3" style="color:#1cc88a; font-weight:600;">Completed Orders</h4>
                        {% if completed_orders %}
                            <ul class="list-group mb-4">
                                {% for order in completed_orders %}
                                <li class="list-group-item d-flex justify-content-between align-items-center border-0 border-bottom py-3" style="background:rgba(28,200,138,0.06);">
                                    <span>
                                        <span class="fw-bold">{{ order.product.title }}</span> (x{{ order.quantity }}) - <span style="color:#1cc88a;">${{ order.total_price }}</span>
                                    </span>
                                    <span class="badge bg-success">Completed</span>
                                    <span class="text-muted small">{{ order.created_at|date:'Y-m-d H:i' }}</span>
                                </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p class="text-center text-muted">No completed orders yet.</p>
                        {% endif %}
                    </div>
                </div>
                <div class="card shadow-sm mt-4 border-0 rounded-4">
                    <div class="card-body">
                        <h4 class="mb-3" style="color:#212529; font-weight:600;">All Orders</h4>
                        {% if buyer_orders %}
                            <ul class="list-group mb-4">
                                {% for order in buyer_orders %}
                                <li class="list-group-item d-flex justify-content-between align-items-center border-0 border-bottom py-3" style="background:rgba(33,37,41,0.04);">
                                    <span>
                                        <span class="fw-bold">{{ order.product.title }}</span> (x{{ order.quantity }}) - <span style="color:#212529;">${{ order.total_price }}</span>
                                    </span>
                                    <span class="badge bg-secondary">{{ order.get_status_display }}</span>
                                    <span class="text-muted small">{{ order.created_at|date:'Y-m-d H:i' }}</span>
                                </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p class="text-center text-muted">No orders found.</p>
                        {% endif %}
                    </div>
                </div>
            {% elif role == 'seller' %}
            <style>
                :root { --primary:#4da8da; --primary-dark:#1e88e5; --danger:#e74c3c; --success:#27ae60; --warning:#f39c12; --gray-50:#f8f9fa; --gray-200:#eeeeee; --gray-600:#757575; --gray-800:#424242; }
                .orders-shell{background:#fff;border:1px solid var(--gray-200);border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.06);padding:1.5rem;margin-bottom:1.5rem;}
                .orders-header h1{font-size:1.5rem;font-weight:700;color:#2c3e50;display:flex;align-items:center;gap:.6rem;margin:0 0 .5rem;}
                .status-tabs{display:flex;flex-wrap:wrap;gap:.5rem;margin-bottom:1rem;}
                .status-tab{padding:.55rem .9rem;border:1px solid var(--gray-200);border-radius:8px;background:#fff;font-size:.75rem;font-weight:600;color:#2c3e50;cursor:pointer;}
                .status-tab.active{background:var(--primary);color:#fff;border-color:var(--primary);}
                table.orders-table{width:100%;border-collapse:collapse;font-size:.85rem;}
                table.orders-table th{background:var(--gray-50);text-align:left;padding:.7rem .6rem;font-weight:600;color:#2c3e50;border-bottom:1px solid var(--gray-200);}
                table.orders-table td{padding:.65rem .6rem;border-bottom:1px solid var(--gray-200);vertical-align:middle;}
                .badge-status{display:inline-block;padding:4px 9px;border-radius:999px;font-size:.65rem;font-weight:700;letter-spacing:.5px;text-transform:uppercase;}
                .st-p{background:#adb5bd;color:#212529;}
                .st-w{background:rgba(243,156,18,.15);color:var(--warning);}
                .st-c{background:rgba(39,174,96,.15);color:var(--success);} 
                .action-btn-sm{padding:4px 10px;border-radius:8px;border:1px solid var(--primary);background:#fff;color:var(--primary);font-size:.7rem;font-weight:600;cursor:pointer;}
                .action-btn-sm:hover{background:var(--primary);color:#fff;}
                .drawer{position:fixed;top:0;right:-420px;width:400px;height:100vh;background:#fff;box-shadow:-2px 0 12px rgba(0,0,0,.15);transition:.35s;z-index:1100;padding:1.25rem;overflow-y:auto;}
                .drawer.open{right:0;}
                .drawer h3{font-size:1.1rem;font-weight:700;margin:0 0 .75rem;}
                .drawer-close{background:none;border:none;font-size:1.4rem;cursor:pointer;color:#777;}
                @media(max-width:992px){.drawer{width:100%;}}
            </style>
            <div class="orders-shell orders-header">
                <h1><i class="fas fa-clipboard-list text-primary"></i> Seller Orders</h1>
                <p class="text-muted mb-2" style="font-size:.85rem;">Manage incoming orders, request completion, and review history.</p>
                <div class="status-tabs" id="sellerStatusTabs">
                    <div class="status-tab active" data-filter="all">All</div>
                    <div class="status-tab" data-filter="P">Pending ({{ seller_pending_orders|length }})</div>
                    <div class="status-tab" data-filter="W">Waiting ({{ seller_waiting_orders|length }})</div>
                    <div class="status-tab" data-filter="C">Completed ({{ seller_completed_orders|length }})</div>
                </div>
                <div class="table-responsive">
                    <table class="orders-table" id="sellerOrdersTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Product</th>
                                <th>Buyer</th>
                                <th>Qty</th>
                                <th>Total</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                        {% for order in seller_orders %}
                            <tr data-status="{{ order.status }}">
                                <td>{{ order.id }}</td>
                                <td><strong>{{ order.product.title }}</strong></td>
                                <td>{{ order.user.username }}</td>
                                <td>{{ order.quantity }}</td>
                                <td>ETB {{ order.total_price }}</td>
                                <td>
                                    <span class="badge-status st-{{ order.status|lower }}">{{ order.get_status_display }}</span>
                                </td>
                                <td>{{ order.created_at|date:'Y-m-d H:i' }}</td>
                                <td>
                                    {% if order.status == 'P' %}
                                        <button class="action-btn-sm" onclick="requestOrderComplete('{{ order.id }}','{{ order.user.id }}')">Request Complete</button>
                                    {% elif order.status == 'W' %}
                                        <span class="text-muted" style="font-size:.7rem;">Waiting buyer</span>
                                    {% else %}
                                        <span class="text-success" style="font-size:.7rem;">Done</span>
                                    {% endif %}
                                    <button class="action-btn-sm" onclick="openOrderDrawer('{{ order.id }}')">View</button>
                                </td>
                            </tr>
                        {% empty %}
                            <tr><td colspan="8" class="text-center text-muted">No orders yet.</td></tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="drawer" id="orderDrawer" aria-hidden="true">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h3 id="drawerTitle">Order Detail</h3>
                    <button class="drawer-close" onclick="closeOrderDrawer()">&times;</button>
                </div>
                <div id="drawerBody" style="font-size:.85rem;"></div>
            </div>
            <script>
                const tabs=document.getElementById('sellerStatusTabs').querySelectorAll('.status-tab');
                const tbody=document.querySelector('#sellerOrdersTable tbody');
                tabs.forEach(t=>t.addEventListener('click',()=>{tabs.forEach(x=>x.classList.remove('active'));t.classList.add('active');const f=t.dataset.filter;[...tbody.querySelectorAll('tr')].forEach(r=>{r.style.display=(f==='all'||r.dataset.status===f)?'table-row':'none';});}));
                function openOrderDrawer(id){const row=[...tbody.querySelectorAll('tr')].find(r=>r.firstElementChild.textContent.trim()===id);if(!row)return;const cells=row.querySelectorAll('td');const body=document.getElementById('drawerBody');body.innerHTML=`<p><strong>Product:</strong> ${cells[1].textContent}</p><p><strong>Buyer:</strong> ${cells[2].textContent}</p><p><strong>Quantity:</strong> ${cells[3].textContent}</p><p><strong>Total:</strong> ${cells[4].textContent}</p><p><strong>Status:</strong> ${cells[5].textContent}</p><p><strong>Created:</strong> ${cells[6].textContent}</p>`;document.getElementById('orderDrawer').classList.add('open');}
                function closeOrderDrawer(){document.getElementById('orderDrawer').classList.remove('open');}
                function requestOrderComplete(orderId,buyerId){fetch(`/warehouse/order/${orderId}/request-complete/`,{method:'POST',headers:{'X-CSRFToken':'{{ csrf_token }}','Content-Type':'application/json'},body:JSON.stringify({buyer_id:buyerId})}).then(r=>r.json()).then(d=>{if(d.success){showToast('Completion request sent.','success');updateRowStatus(orderId,'W','Waiting for buyer');}else{showToast(d.error||'Error','danger');}});}
                function updateRowStatus(orderId,code,label){const row=[...tbody.querySelectorAll('tr')].find(r=>r.firstElementChild.textContent.trim()===orderId);if(!row)return;row.dataset.status=code;const badge=row.querySelector('.badge-status');if(badge){badge.className='badge-status st-'+code.toLowerCase();badge.textContent=label==='Waiting for buyer'?'Waiting for buyer confirmation':label;}}
            </script>
            {% endif %}
        </div>
    </div>
</div>
{% if messages %}
  <div id="centered-django-messages">
    {% for message in messages %}
      <div class="centered-message {{ message.tags }}">{{ message }}</div>
    {% endfor %}
  </div>
  <script>
    // Auto-hide Django messages after 7s (was 3.5s)
    setTimeout(function() {
      const msgDiv = document.getElementById('centered-django-messages');
      if (msgDiv) msgDiv.style.display = 'none';
    }, 7000);
  </script>
{% endif %}
<!--
To use this notification overlay on all pages, copy the Django messages block and CSS to your base.html or any template.
Include the .centered-message and #centered-django-messages CSS for consistent style.
-->
<style>
/* Centered notification overlay styles */
#centered-notification {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    min-width: 320px;
    max-width: 90vw;
    z-index: 3000;
    background: rgba(255,255,255,0.98);
    border-radius: 18px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.18);
    padding: 32px 24px 24px 24px;
    text-align: center;
    font-size: 1.15rem;
    font-weight: 500;
    transition: opacity 0.3s;
    border: 2px solid #eee;
}
#centered-notification.success { border-color: #28a745; color: #28a745; }
#centered-notification.danger { border-color: #dc3545; color: #dc3545; }
#centered-notification.info { border-color: #0d6efd; color: #0d6efd; }
#centered-notification .close-btn {
    position: absolute;
    top: 10px;
    right: 18px;
    background: none;
    border: none;
    font-size: 1.5rem;
    color: #888;
    cursor: pointer;
}
#centered-django-messages {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 4000;
    min-width: 320px;
    max-width: 90vw;
    text-align: center;
}
.centered-message {
    display: inline-block;
    background: rgba(255,255,255,0.98);
    border-radius: 18px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.18);
    padding: 24px 18px 18px 18px;
    font-size: 1.1rem;
    font-weight: 500;
    margin: 0.5rem 0;
    border: 2px solid #eee;
    transition: opacity 0.3s;
}
.centered-message.success { border-color: #28a745; color: #28a745; }
.centered-message.error, .centered-message.danger { border-color: #dc3545; color: #dc3545; }
.centered-message.info { border-color: #0d6efd; color: #0d6efd; }
@media (max-width: 600px) {
    #centered-notification { min-width: 80vw; padding: 18px 8px 18px 8px; font-size: 1rem; }
    #centered-notification .close-btn { right: 8px; }
    #centered-django-messages, .centered-message { min-width: 80vw; font-size: 1rem; }
}
</style>
<div id="centered-notification"><button class="close-btn" onclick="hideNotification()">&times;</button><span id="centered-notification-message"></span></div>
<script>
function showToast(message, type='info') {
    // Use new centered notification overlay
    const notif = document.getElementById('centered-notification');
    const msg = document.getElementById('centered-notification-message');
    notif.className = type;
    msg.innerHTML = message;
    notif.style.display = 'block';
    notif.style.opacity = 1;
    // Auto-hide after 3.5s unless user closes
    if (notif._timeout) clearTimeout(notif._timeout);
    notif._timeout = setTimeout(() => { hideNotification(); }, 3500);
}
function hideNotification() {
    const notif = document.getElementById('centered-notification');
    notif.style.opacity = 0;
    setTimeout(() => { notif.style.display = 'none'; }, 300);
}
function showOrderDetail(orderId) {
    document.getElementById('order-detail-' + orderId).style.display = 'block';
}
function hideOrderDetail(orderId) {
    document.getElementById('order-detail-' + orderId).style.display = 'none';
}
function requestOrderComplete(orderId, buyerId) {
        fetch(`/warehouse/order/${orderId}/request-complete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({buyer_id: buyerId})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Completion request sent to buyer.', 'success');
                hideOrderDetail(orderId);
            } else {
                showToast('Error: ' + data.error, 'danger');
            }
        });
}
function confirmOrderComplete(orderId) {
    // Show notification immediately
    showToast('Order marked as completed. Thank you for confirming!', 'success');
    fetch(`/warehouse/order/${orderId}/confirm-complete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            showToast('Error: ' + data.error, 'danger');
        }
        // Move order from waiting_orders to completed_orders in DOM
        const waitingList = document.querySelector('h4:contains("Orders Waiting for Your Confirmation") + ul');
        const completedList = document.querySelector('h4:contains("Completed Orders") + ul');
        const allOrdersList = document.querySelector('h4:contains("All Orders") + ul');
        let li = null;
        if (waitingList) {
            li = waitingList.querySelector(`li.list-group-item button[onclick*="confirmOrderComplete('${orderId}')"]`);
            if (li) li = li.closest('li');
        }
        if (li && completedList) {
            // Remove from waiting
            li.parentNode.removeChild(li);
            // Create new completed order li
            const completedLi = document.createElement('li');
            completedLi.className = 'list-group-item';
            completedLi.innerHTML = `${li.innerHTML.replace('Waiting for Your Confirmation', 'Completed').replace('btn btn-warning btn-sm ms-2', '').replace('onclick=\"confirmOrderComplete(\'${orderId}\')\"', '')}<span class=\"badge bg-success\">Completed</span>`;
            completedList.appendChild(completedLi);
        }
        // Also update All Orders badge if present
        if (li && allOrdersList) {
            const allLi = allOrdersList.querySelector(`li.list-group-item:has(span.badge.bg-secondary:contains("Pending"))`);
            if (allLi) {
                allLi.querySelector('span.badge').classList.remove('bg-secondary');
                allLi.querySelector('span.badge').classList.add('bg-success');
                allLi.querySelector('span.badge').innerText = 'Completed';
            }
        }
    });
}
</script>
{% endblock %}
